name: Action-Test

run-name: "Action-Test - [${{ github.event.pull_request.title }} #${{ github.event.pull_request.number }}] by @${{ github.actor }}"

on:
  workflow_dispatch:
  pull_request:
  schedule:
    - cron: '0 0 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  ActionTestBasic:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macOS-latest]
        version: ['latest', 'preview', '7.4.7', '7.5.0']
    runs-on: ${{ matrix.os }}
    name: '${{ matrix.os }} - [${{ matrix.version }}]'
    steps:
      - name: Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Action-Test
        uses: ./
        with:
          Version: ${{ matrix.version == 'preview' && 'latest' || matrix.version }}
          Preview: ${{ matrix.version == 'preview' && 'true' || 'false' }}

      - name: Verify installed version
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Requested version that came from the matrix
          $requested = '${{ matrix.version }}'

          # When 'preview' → resolve to latest preview release
          if ($requested.Trim().ToLower() -eq 'preview') {
              $releases = Invoke-RestMethod -Uri 'https://api.github.com/repos/PowerShell/PowerShell/releases' `
                -Headers @{
                  'Accept' = 'application/vnd.github+json'
                  'Authorization' = "Bearer $($env:GITHUB_TOKEN)"
                  'X-GitHub-Api-Version' = '2022-11-28'
                }
              $requested = ($releases | Where-Object { $_.prerelease -eq $true } | Select-Object -First 1).tag_name.TrimStart('v')
              Write-Host "Resolved 'preview' → $requested"
          }
          # When empty / 'null' / 'latest' → resolve to latest stable release
          elseif ([string]::IsNullOrWhiteSpace($requested) -or
              $requested.Trim().ToLower() -in @('latest','null')) {

              $requested = (
                Invoke-RestMethod -Uri 'https://api.github.com/repos/PowerShell/PowerShell/releases/latest' `
                -Headers @{
                  'Accept' = 'application/vnd.github+json'
                  'Authorization' = "Bearer $($env:GITHUB_TOKEN)"
                  'X-GitHub-Api-Version' = '2022-11-28'
                }
              ).tag_name.TrimStart('v')
              Write-Host "Resolved 'latest' → $requested"
          }

          # Parse the major version from the requested version string
          $majorVersion = $requested -replace '-.*$', '' | ForEach-Object { ($_ -split '\.')[0] }
          Write-Host "Detected major version: $majorVersion"

          # Determine the installation directory based on preview vs stable
          $isPreview = '${{ matrix.version }}'.Trim().ToLower() -eq 'preview' -or $requested -match '-preview\.'
          if ($isPreview) {
              $installDir = "$majorVersion-preview"
          } else {
              $installDir = "$majorVersion"
          }

          $pwshPath = "$env:ProgramFiles\PowerShell\$installDir\pwsh.exe"
          Write-Host "Expected pwsh location: $pwshPath"

          # Verify the file exists
          if (-not (Test-Path $pwshPath)) {
              Write-Host "ERROR: PowerShell executable not found at expected path: $pwshPath"
              Write-Host "`nSearching for all pwsh.exe installations..."
              Get-ChildItem "$env:ProgramFiles\PowerShell" -Recurse -Filter "pwsh.exe" -ErrorAction SilentlyContinue | 
                ForEach-Object { Write-Host "  Found: $($_.FullName)" }
              throw "PowerShell executable not found at: $pwshPath"
          }

          # Get the version from the installed executable
          $installed = (& $pwshPath -NoLogo -NoProfile -Command '$PSVersionTable.PSVersion.ToString()')
          Write-Host "Installed PowerShell version: $installed"
          Write-Host "Expected  PowerShell version: $requested"

          if ($installed -ne $requested) {
              throw "Failed: expected $requested but got $installed"
          }
